<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Laporan Kelahiran & Kematian</title>

    <!-- Bootstrap 5 & DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f3f6fa;
        font-family: "Poppins", sans-serif;
        padding: 20px;
      }

      .header-gradient {
        background: linear-gradient(135deg, #0d6efd, #6610f2);
        color: white;
        border-radius: 16px;
        padding: 28px 24px;
        text-align: center;
        margin-bottom: 30px;
        box-shadow: 0 6px 20px rgba(13, 110, 253, 0.3);
      }

      .header-gradient h2 {
        font-weight: 700;
        margin-bottom: 10px;
      }

      .card {
        border: none;
        border-radius: 14px;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
        padding: 20px;
        margin-bottom: 25px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.1);
      }

      .card h5 {
        font-weight: 600;
        margin-bottom: 16px;
      }

      .kelahiran-card h5 {
        color: #0d6efd;
      }

      .kematian-card h5 {
        color: #dc3545;
      }

      canvas {
        background: #fff;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
      }

      table thead th {
        background-color: #0d6efd;
        color: #fff !important;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.4px;
      }

      table tbody tr:hover {
        background-color: #e7f1ff;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.3rem 0.6rem;
      }

      .footer-note {
        text-align: center;
        font-size: 0.85rem;
        color: #777;
        margin-top: 20px;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="header-gradient">
        <h2>ðŸ“Š Laporan Data Kelahiran & Kematian</h2>
        <p class="mb-0">
          Puskesmas / Dinas Kesehatan â€” Dashboard Statistik Bulanan
        </p>
      </div>
      <div class="mt-2 mb-4">
        <a
          href="index.html"
          class="btn btn-outline-success btn-sm px-4 shadow-sm"
        >
          âž• Input Data
        </a>
      </div>
      <!-- Tren Bulanan -->
      <div class="card">
        <h5>ðŸ“ˆ Tren Bulanan</h5>
        <canvas id="chartTren" height="100"></canvas>
      </div>

      <!-- Data Kelahiran -->
      <div class="card kelahiran-card">
        <h5>ðŸ‘¶ Data Kelahiran</h5>
        <div class="table-responsive">
          <table
            id="tabelKelahiran"
            class="table table-striped table-hover"
            style="width: 100%"
          ></table>
        </div>
      </div>

      <!-- Data Kematian -->
      <div class="card kematian-card">
        <h5>ðŸª¦ Data Kematian</h5>
        <div class="table-responsive">
          <table
            id="tabelKematian"
            class="table table-striped table-hover"
            style="width: 100%"
          ></table>
        </div>
      </div>

      <div class="footer-note">Â© 2025 Puskesmas Trenggalek | @Yoga</div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwONhP_0zc5u3ThodgvX1ebDWOZWOgcVvn8Uy09LioGJAZYSTjDoFXw8d1kOpZrQ2CF2A/exec";

      function formatTanggal(value) {
        if (!value) return "";
        const d = new Date(value);
        if (isNaN(d)) return value;
        return d.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }

      function prettyTitle(key) {
        return String(key)
          .replace(/_/g, " ")
          .replace(/\s+/g, " ")
          .trim()
          .split(" ")
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      function detectDateField(rows) {
        if (!rows || rows.length === 0) return [];
        const sample = Object.keys(rows[0]);
        return sample.filter((k) => /tanggal|tgl|date|input/i.test(k));
      }

      // âœ… Fungsi untuk membangun DataTable dengan header otomatis
      function buildDataTable(selector, data, warna = "#0d6efd") {
        const $table = $(selector);
        let columns = [];
        let dataSet = [];

        if (data && data.length > 0) {
          const keys = Object.keys(data[0]);
          const dateFields = detectDateField(data);

          columns = keys.map((k) => ({
            data: k,
            title: prettyTitle(k),
            render: dateFields.includes(k)
              ? (d) => formatTanggal(d)
              : (d) => d || "",
          }));

          dataSet = data;
        } else {
          // Jika data kosong
          columns = [{ title: "Tidak ada data", data: null }];
          dataSet = [];
        }

        if ($.fn.dataTable.isDataTable(selector)) {
          $table.DataTable().clear().destroy();
          $table.empty();
        }

        $table.DataTable({
          data: dataSet,
          columns: columns,
          pageLength: 10,
          lengthMenu: [10, 25, 50, 100],
          order: [[0, "asc"]],
          language: {
            search: "Cari:",
            lengthMenu: "Tampilkan _MENU_ data",
            info: "Menampilkan _START_â€“_END_ dari _TOTAL_ data",
            infoEmpty: "Tidak ada data tersedia",
            paginate: {
              previous: "Sebelumnya",
              next: "Berikutnya",
            },
            emptyTable: "Tidak ada data untuk ditampilkan",
          },
          createdRow: function (row, data, index) {
            $("td", row).css("vertical-align", "middle");
          },
          initComplete: function () {
            // Terapkan warna header sesuai tema
            $(selector + " thead th").css({
              backgroundColor: warna,
              color: "#fff",
              fontWeight: "600",
            });
          },
        });
      }

      async function fetchSheet(sheetName) {
        const url = new URL(API_URL);
        url.searchParams.set("action", "getData");
        url.searchParams.set("sheet", sheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      }

      let lineChart;
      function updateTrendChart(kelahiran, kematian) {
        const agg = { kelahiran: {}, kematian: {} };

        function countPerMonth(rows, key) {
          const dateCols = detectDateField(rows);
          const col = dateCols.length ? dateCols[0] : Object.keys(rows[0])[0];
          rows.forEach((r) => {
            const val = new Date(r[col]);
            if (isNaN(val)) return;
            const ym = `${val.getFullYear()}-${String(
              val.getMonth() + 1
            ).padStart(2, "0")}`;
            agg[key][ym] = (agg[key][ym] || 0) + 1;
          });
        }

        countPerMonth(kelahiran, "kelahiran");
        countPerMonth(kematian, "kematian");

        const labels = Array.from(
          new Set([...Object.keys(agg.kelahiran), ...Object.keys(agg.kematian)])
        ).sort();

        const dataKelahiran = labels.map((l) => agg.kelahiran[l] || 0);
        const dataKematian = labels.map((l) => agg.kematian[l] || 0);

        const ctx = document.getElementById("chartTren").getContext("2d");
        if (lineChart) lineChart.destroy();

        lineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Kelahiran",
                data: dataKelahiran,
                borderColor: "#0d6efd",
                backgroundColor: "rgba(13,110,253,0.15)",
                tension: 0.4,
                fill: true,
              },
              {
                label: "Kematian",
                data: dataKematian,
                borderColor: "#dc3545",
                backgroundColor: "rgba(220,53,69,0.15)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
            },
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } },
            },
          },
        });
      }

      (async function init() {
        try {
          const [kelahiran, kematian] = await Promise.all([
            fetchSheet("Data Kelahiran"),
            fetchSheet("Data Kematian"),
          ]);

          // Warna header disesuaikan
          buildDataTable("#tabelKelahiran", kelahiran, "#0d6efd");
          buildDataTable("#tabelKematian", kematian, "#dc3545");

          updateTrendChart(kelahiran, kematian);
        } catch (err) {
          console.error(err);
          alert("Gagal memuat data: " + err.message);
        }
      })();
    </script>
  </body>
</html>
