<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Laporan Kelahiran & Kematian</title>

    <!-- Bootstrap & DataTables -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />

    <style>
      body {
        background: #f4f7fb;
        font-family: "Poppins", sans-serif;
        padding: 18px;
      }

      /* Header */
      .header-gradient {
        background: linear-gradient(135deg, #b6cf9f, #396317);
        color: white;
        border-radius: 18px;
        padding: 28px 24px;
        text-align: center;
        margin-bottom: 25px;
        box-shadow: 0 6px 20px rgba(10, 97, 18, 0.555);
      }

      .header-gradient h2 {
        font-weight: 700;
        margin-bottom: 8px;
      }

      /* Tombol aksi */
      .action-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 10px;
      }

      .btn-print {
        display: flex;
        align-items: center;
        gap: 6px;
        border-radius: 10px;
        font-weight: 500;
      }

      @media (max-width: 576px) {
        .btn-print span {
          display: none;
        }
      }

      /* Card */
      .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 6px 24px rgba(0, 0, 0, 0.08);
        padding: 22px;
        margin-bottom: 25px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.12);
      }

      .card h5 {
        font-weight: 600;
        margin-bottom: 18px;
      }

      .kelahiran-card h5 {
        color: #27803a;
      }

      .kematian-card h5 {
        color: #dc3545;
      }

      canvas {
        background: #fff;
        border-radius: 14px;
        padding: 8px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.05);
      }

      /* Tabel */
      table thead th {
        background-color: #206b1e;
        color: #fff !important;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.4px;
      }

      table tbody tr:hover {
        background-color: #e8f0ff;
      }

      .dataTables_wrapper .dataTables_paginate .paginate_button {
        padding: 0.3rem 0.6rem;
      }

      /* Footer */
      .footer-note {
        text-align: center;
        font-size: 0.85rem;
        color: #777;
        margin-top: 20px;
      }
      /* Ukuran font header tabel */
      table thead th {
        background-color: #206b1e;
        color: #fff !important;
        text-transform: uppercase;
        font-size: 11px !important; /* ðŸ”¹ lebih kecil dari sebelumnya (0.85rem â‰ˆ 13.6px) */
        letter-spacing: 0.5px;
        padding: 6px 10px !important;
        vertical-align: middle;
      }

      /* Isi tabel juga sedikit dikecilkan agar proporsional */
      table tbody td {
        font-size: 11.5px !important;
        padding: 6px 10px !important;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Header -->
      <div class="header-gradient">
        <h2>ðŸ“Š Laporan Kelahiran & Kematian</h2>
        <p class="mb-0">
          Puskesmas / Dinas Kesehatan â€” Dashboard Statistik Bulanan
        </p>
      </div>

      <!-- Tombol aksi -->
      <div class="action-bar">
        <a href="index.html" class="btn btn-outline-success shadow-sm">
          <i class="fa-solid fa-circle-plus me-2"></i> Input Data
        </a>

        <!-- <button
          class="btn btn-primary btn-print shadow-sm"
          onclick="window.print()"
        >
          <i class="fa-solid fa-print"></i> <span>Cetak Laporan</span>
        </button> -->
      </div>

      <!-- Grafik Tren -->
      <div class="card">
        <h5>
          <i class="fa-solid fa-chart-line me-2 text-primary"></i> Tren Bulanan
        </h5>
        <canvas id="chartTren" height="100"></canvas>
      </div>

      <!-- Data Kelahiran -->
      <div class="card kelahiran-card">
        <h5><i class="fa-solid fa-baby me-2"></i> Data Kelahiran</h5>
        <div class="table-responsive">
          <table
            id="tabelKelahiran"
            class="table table-striped table-hover align-middle"
            style="width: 100%; font-size: 12px"
          ></table>
        </div>
      </div>

      <!-- Data Kematian -->
      <div class="card kematian-card">
        <h5><i class="fa-solid fa-cross me-2"></i> Data Kematian</h5>
        <div class="table-responsive">
          <table
            id="tabelKematian"
            class="table table-striped table-hover align-middle"
            style="width: 100%; font-size: 12px"
          ></table>
        </div>
      </div>

      <div class="footer-note">Â© 2025 Puskesmas Trenggalek | @Yoga</div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwONhP_0zc5u3ThodgvX1ebDWOZWOgcVvn8Uy09LioGJAZYSTjDoFXw8d1kOpZrQ2CF2A/exec";

      function formatTanggal(value) {
        if (!value) return "";
        const d = new Date(value);
        if (isNaN(d)) return value;
        return d.toLocaleDateString("id-ID", {
          day: "2-digit",
          month: "2-digit",
          year: "numeric",
        });
      }

      function prettyTitle(key) {
        return String(key)
          .replace(/_/g, " ")
          .replace(/\s+/g, " ")
          .trim()
          .split(" ")
          .map((w) => w.charAt(0).toUpperCase() + w.slice(1))
          .join(" ");
      }

      function detectDateField(rows) {
        if (!rows || rows.length === 0) return [];
        const sample = Object.keys(rows[0]);
        return sample.filter((k) => /tanggal|tgl|date|input/i.test(k));
      }
      // âœ… Tambahkan deteksi kolom jam
      function detectTimeField(rows) {
        if (!rows || rows.length === 0) return [];
        const sample = Object.keys(rows[0]);
        return sample.filter((k) => /jam|waktu|time/i.test(k));
      }

      function formatJam(value) {
        if (!value) return "";
        // Jika format ISO date string seperti 1899-12-30T06:25:48.000Z
        const date = new Date(value);
        if (!isNaN(date)) {
          return date.toLocaleTimeString("id-ID", {
            hour: "2-digit",
            minute: "2-digit",
            hour12: false,
          });
        }

        // Jika hanya string "06:25" tetap tampilkan
        const match = value.match(/^(\d{1,2}):(\d{2})/);
        return match ? match[0] : value;
      }
      function buildDataTable(selector, data, warna = "#0d6efd") {
        const $table = $(selector);
        let columns = [];
        let dataSet = [];

        if (data && data.length > 0) {
          const keys = Object.keys(data[0]);
          const dateFields = detectDateField(data);
          const timeFields = detectTimeField(data);

          columns = keys.map((k) => ({
            data: k,
            title: prettyTitle(k),
            render: (d) => {
              if (dateFields.includes(k)) return formatTanggal(d);
              if (timeFields.includes(k)) return formatJam(d);
              return d || "";
            },
          }));

          dataSet = data;
        } else {
          columns = [{ title: "Tidak ada data", data: null }];
          dataSet = [];
        }

        if ($.fn.dataTable.isDataTable(selector)) {
          $table.DataTable().clear().destroy();
          $table.empty();
        }

        $table.DataTable({
          data: dataSet,
          columns: columns,
          pageLength: 10,
          lengthMenu: [10, 25, 50, 100],
          order: [[0, "asc"]],
          language: {
            search: "Cari:",
            lengthMenu: "Tampilkan _MENU_ data",
            info: "Menampilkan _START_â€“_END_ dari _TOTAL_ data",
            infoEmpty: "Tidak ada data tersedia",
            paginate: { previous: "Sebelumnya", next: "Berikutnya" },
            emptyTable: "Tidak ada data untuk ditampilkan",
          },
          createdRow: (row) => $("td", row).css("vertical-align", "middle"),
          initComplete: () => {
            $(selector + " thead th").css({
              backgroundColor: warna,
              color: "#fff",
              fontWeight: "600",
            });
          },
        });
      }

      async function fetchSheet(sheetName) {
        const url = new URL(API_URL);
        url.searchParams.set("action", "getData");
        url.searchParams.set("sheet", sheetName);
        const res = await fetch(url);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return res.json();
      }

      let lineChart;
      function updateTrendChart(kelahiran, kematian) {
        const agg = { kelahiran: {}, kematian: {} };

        function countPerMonth(rows, key) {
          const dateCols = detectDateField(rows);
          const col = dateCols.length ? dateCols[0] : Object.keys(rows[0])[0];
          rows.forEach((r) => {
            const val = new Date(r[col]);
            if (isNaN(val)) return;
            const ym = `${val.getFullYear()}-${String(
              val.getMonth() + 1
            ).padStart(2, "0")}`;
            agg[key][ym] = (agg[key][ym] || 0) + 1;
          });
        }

        countPerMonth(kelahiran, "kelahiran");
        countPerMonth(kematian, "kematian");

        const labels = Array.from(
          new Set([...Object.keys(agg.kelahiran), ...Object.keys(agg.kematian)])
        ).sort();

        const dataKelahiran = labels.map((l) => agg.kelahiran[l] || 0);
        const dataKematian = labels.map((l) => agg.kematian[l] || 0);

        const ctx = document.getElementById("chartTren").getContext("2d");
        if (lineChart) lineChart.destroy();

        lineChart = new Chart(ctx, {
          type: "line",
          data: {
            labels,
            datasets: [
              {
                label: "Kelahiran",
                data: dataKelahiran,
                borderColor: "#0d6efd",
                backgroundColor: "rgba(13,110,253,0.15)",
                tension: 0.4,
                fill: true,
              },
              {
                label: "Kematian",
                data: dataKematian,
                borderColor: "#dc3545",
                backgroundColor: "rgba(220,53,69,0.15)",
                tension: 0.4,
                fill: true,
              },
            ],
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: "bottom" },
            },
            scales: {
              y: { beginAtZero: true, ticks: { stepSize: 1 } },
            },
          },
        });
      }

      (async function init() {
        try {
          const [kelahiran, kematian] = await Promise.all([
            fetchSheet("Sheet2"),
            fetchSheet("Sheet1"),
          ]);

          buildDataTable("#tabelKelahiran", kelahiran, "#0d6efd");
          buildDataTable("#tabelKematian", kematian, "#dc3545");
          updateTrendChart(kelahiran, kematian);
        } catch (err) {
          console.error(err);
          alert("Gagal memuat data: " + err.message);
        }
      })();
    </script>
  </body>
</html>
